$(document).ready(function() {
   //global variables
   var albumsArray = []; //the array is now populated from the database using populateAlbumArray();
   var filteredAlbumsArray = []; //populated after a filtering parameter is entered in textboxes
   var albumIDsString = "";
   $("#checkboxContainer").hide();
   $("#col1").hide();
   $("#col2").hide();
   $("#col3").hide();

   //API call using Ajax to populate albums array from database. Uses app.get("/api/populateAlbumsArray") route in App.js
   populateAlbumArray();
   
   // Get contents of current cart.
   getCart();

   function populateAlbumArray() {
      $.ajax({
         method: "GET",
         url: "/api/populateAlbumsArray",
         type: "JSON",
         async: false,

         success: function(data, status) {

            data.forEach(function(elem, i) {
               console.log("Album data is:" + data);
               albumsArray[i] = { albumID: elem.albumID, title: elem.title, artist: elem.artist, coverImage: elem.coverImage, price: elem.price, genre: elem.genre};
            });
         }
      }); //ajax
   } //populateAlbumArray()
   
    //API call to get cart albumIDs added in search.ejs
    function getCart(){
        $.ajax({
            method: "GET",
            url: "/api/getCart",
            async: false,
            
            success: function(data, status){
                let string = JSON.stringify(data);
                let newString = string.replace('[{"albumIDs":"', "").replace(' "}]', "").split(' ').toString();
                
                // Add cleaned string to global album IDs string.
                let lastCharNumber = false;
                for (let i = 0; i < newString.length; i++) {
                    if (!isNaN(newString.charAt(i)) && newString.charAt(i) != " ") {
                        albumIDsString += newString.charAt(i);
                        lastCharNumber = true;
                    }
                    else {
                        if (lastCharNumber) {
                            albumIDsString += " ";
                        }
                        lastCharNumber = false;
                    }
                }
            }//success
        });//ajax
    }//getCart()

   //API call to set customer cart in database once add to cart button is clicked
   function setCart(albumIDs, customerID) {
      $.ajax({
         method: "GET",
         url: "/api/setCart",
         data: {
            "albumIDs": albumIDs,
            "customerID": customerID
         },

         success: function(data, status) {
            console.log("Data from setCart" + data + "Status" + status);
         }
      }); //ajax
   } //setCart()

   //function to find albums by name or artist and display them to user
   $("#albumSearch").on("change", function() {
      $("#searchResult").html("");
      let searchValue = $("#albumSearch").val().toLowerCase();
      
      ($("#priceSearch").val() == "") ? showSearchResults(searchValue, false) : showSearchResults(searchValue, true);
   });

   $("#priceSearch").on("change", function() {
       $("#searchResult").html("");
      let priceValue = $("#priceSearch").val();
      
      ($("#albumSearch").val() == "") ? showSearchResults(priceValue, false) : showSearchResults(priceValue, true);
   });

   
   //shows search results based on search by title/genre/artist or price 
   function showSearchResults(searchParam, filteredBoolean) {

      let itemFound = false;
      console.dir(albumsArray);
      $("#checkboxContainer").show();
      
      if (!filteredBoolean) {
         //search albums and display results
         filteredAlbumsArray = [];//reset filtered albums array
         
         for (let i = 0; i < albumsArray.length; i++) {
            let titleBoolean = albumsArray[i].title.toLowerCase().includes(searchParam);
            let artistBoolean = albumsArray[i].artist.toLowerCase().includes(searchParam);
            let genreBoolean = (albumsArray[i].genre == searchParam);
   
            if (titleBoolean || artistBoolean || genreBoolean || (albumsArray[i].price <= searchParam) || searchParam == "all") {
               filteredAlbumsArray.push(albumsArray[i]);
               
               // $("#searchResult").append(`${albumsArray[i].coverImage} <br />`);
               // $("#searchResult").append(`<strong> Artist: </strong> ${albumsArray[i].artist} <strong> Album: </strong> <i> ${albumsArray[i].title} </i> <strong> <br /> Price: </strong> $${albumsArray[i].price} <br />`);
               // $("#searchResult").append(`<button value=${albumsArray[i].albumID} class="btn btn-outline-secondary"> <strong> Add to Cart </strong> </button> <br /> <br />`);
              
               itemFound = true;
            }
          } 
      }//close non-filtered array search
      
      else if (filteredBoolean) {
         //search albums and display results
         for (let i = 0; i < filteredAlbumsArray.length; i++) {
            let titleBoolean = filteredAlbumsArray[i].title.toLowerCase().includes(searchParam);
            let artistBoolean = filteredAlbumsArray[i].artist.toLowerCase().includes(searchParam);
            let genreBoolean = (filteredAlbumsArray[i].genre == searchParam);
   
            if (titleBoolean || artistBoolean || genreBoolean || (filteredAlbumsArray[i].price <= searchParam)) {
               // $("#searchResult").append(`${filteredAlbumsArray[i].coverImage} <br />`);
               // $("#searchResult").append(`<strong> Artist: </strong> ${filteredAlbumsArray[i].artist} <strong> Album: </strong> <i> ${filteredAlbumsArray[i].title} </i> <strong> <br /> Price: </strong> $${filteredAlbumsArray[i].price} <br />`);
               // $("#searchResult").append(`<button value=${filteredAlbumsArray[i].albumID} class="btn btn-outline-secondary"> <strong> Add to Cart </strong> </button> <br /> <br />`);
               itemFound = true;
            }
          } 
      }//close filtered array search
 
      if (itemFound) {
         displayAlbums();
      }
      else {
         $("#searchResult").html("<p> No results found ... </p>");
      }
   } //close showSearchResults()

   //function to add item to cart when Add button is clicked
   $("#searchResult").on("click", ".btn-outline-secondary", function() {

      let value = $(this).val();
      $(this).html("Album Added!");
      albumIDsString += " ";
      albumIDsString += value;
      console.log( $(this).val() );
      
      setCart(albumIDsString, 0);
   });
   
   //function to apply genre checkbox filters 
      $(".checkBox").on("click", function(){
        $("#searchResult").html("");
        let allUnchecked = true;
         
         $(".checkBox").each(function(){
            let checkboxValue = $(this).val();
            let isChecked = this.checked; 
            
            isChecked ? showSearchResults(checkboxValue, true): "";
            isChecked ? allUnchecked = false: "";
         });
         allUnchecked ? (showSearchResults("all", false)): "";
      });//onClick()
      
      function displayAlbums() {
         
         let numFoundAlbums = filteredAlbumsArray.length;
         
         if (numFoundAlbums == 1) {
               $("#resultsContainer").append(`${filteredAlbumsArray[i].coverImage} <br />`);
               $("#resultsContainer").append(`<strong> Artist: </strong> ${filteredAlbumsArray[i].artist} <strong> Album: </strong> <i> ${filteredAlbumsArray[i].title} </i> <strong> <br /> Price: </strong> $${filteredAlbumsArray[i].price} <br />`);
               $("#resultsContainer").append(`<button value=${filteredAlbumsArray[i].albumID} class="btn btn-outline-secondary"> <strong> Add to Cart </strong> </button> <br /> <br />`);
         }
         else if (numFoundAlbums == 2) {
            $("#resultsContainer").append(` <div id='row'><div />`);
            $("#row").append(` <div id='col1'><div />`);
            $("#col1").css("float", "left");
            $("#col1").css("width", "50%");
            
            $("#row").append(` <div id='col2'><div />`);
            $("#col2").css("float", "left");
            $("#col2").css("width", "50%");
            
            for (let i = 0; i < filteredAlbumsArray.length; i++) {
               let columnNum = i;
               let columnName = "";
               
               if (columnNum == 0)
                  columnName = "#col1";
               else if (columnNum == 1)
                  columnName = "#col2";
                  
               $(columnName).append(`${filteredAlbumsArray[i].coverImage} <br />`);
               $(columnName).append(`<strong> Artist: </strong> ${filteredAlbumsArray[i].artist} <strong> Album: </strong> <i> ${filteredAlbumsArray[i].title} </i> <strong> <br /> Price: </strong> $${filteredAlbumsArray[i].price} <br />`);
               $(columnName).append(`<button value=${filteredAlbumsArray[i].albumID} class="btn btn-outline-secondary"> <strong> Add to Cart </strong> </button> <br /> <br />`);
         }
         }
         else if (numFoundAlbums >= 3) {
            $("#resultsContainer").append(` <div id='row'><div />`);
            $("#row").append(` <div id='col1'><div />`);$("#col1").css("float", "left");
            $("#col1").css("width", "33.33%");
            
            $("#col2").show();
            $("#col2").css("float", "left");
            $("#col2").css("width", "33.33%");
            
            $("#col3").show();
            $("#col3").css("float", "left");
            $("#col3").css("width", "33.33%");
            let rowNum = 0;
            for (let i = 0; i < filteredAlbumsArray.length; i++) {
               let columnNum = i;
               let columnName = "";
               if (i % 3 == 0)
                  rowNum++;
                  
               if (columnNum % 0)
                  columnName = "#col1";
               else if (columnNum % 1)
                  columnName = "#col2";
               else if (columnNum % 2)
                  columnName = "#col3";
                  
               $(columnName).append(`${filteredAlbumsArray[i].coverImage} <br />`);
               $(columnName).append(`<strong> Artist: </strong> ${filteredAlbumsArray[i].artist} <strong> Album: </strong> <i> ${filteredAlbumsArray[i].title} </i> <strong> <br /> Price: </strong> $${filteredAlbumsArray[i].price} <br />`);
               $(columnName).append(`<button value=${filteredAlbumsArray[i].albumID} class="btn btn-outline-secondary"> <strong> Add to Cart </strong> </button> <br /> <br />`);
            }
         }
      }
   
}); //document ready